@using AdminTool.Models
@model CharacterProgressionsVm

@{
    ViewData["Title"] = "Progressions";
}

<div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0">Level Progressions</h2>
    <a asp-action="Index" class="btn btn-outline-secondary">← Back to list</a>
</div>

@if (TempData["toast"] is string toast && !string.IsNullOrWhiteSpace(toast))
{
    <div class="alert alert-success">@toast</div>
}

<div asp-validation-summary="ModelOnly" class="text-danger mb-2"></div>

<form asp-action="Progressions" asp-route-id="@Model.CharacterId" method="post" class="needs-validation">
    @Html.AntiForgeryToken()
    <input type="hidden" asp-for="CharacterId" />

    <div class="card">
        <div class="card-header d-flex align-items-center justify-content-between">
            <div>레벨별 스탯</div>
            <div class="d-flex gap-2">
                <button type="button" id="btnAddRow" class="btn btn-sm btn-outline-primary">+ Row</button>
                <button type="button" id="btnSort" class="btn btn-sm btn-outline-secondary">Sort by Level</button>
                <button type="button" id="btnClear" class="btn btn-sm btn-outline-danger">Clear all</button>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-sm align-middle mb-0" id="progTable">
                    <thead class="table-light">
                        <tr>
                            <th style="width:90px;">Level</th>
                            <th style="width:120px;">HP</th>
                            <th style="width:120px;">ATK</th>
                            <th style="width:120px;">DEF</th>
                            <th style="width:100px;">SPD</th>
                            <th style="width:120px;">CritRate</th>
                            <th style="width:140px;">CritDamage</th>
                            <th style="width:80px;"></th>
                        </tr>
                    </thead>
                    <tbody id="progBody">
                        @for (var i = 0; i < Model.Rows.Count; i++)
                        {
                            <tr data-index="@i">
                                <td>
                                    <input class="form-control form-control-sm"
                                           name="Rows[@i].Level"
                                           value="@Model.Rows[i].Level"
                                           type="number" min="1" step="1" required />
                                </td>
                                <td>
                                    <input class="form-control form-control-sm"
                                           name="Rows[@i].HP"
                                           value="@Model.Rows[i].HP"
                                           type="number" min="0" step="1" required />
                                </td>
                                <td>
                                    <input class="form-control form-control-sm"
                                           name="Rows[@i].ATK"
                                           value="@Model.Rows[i].ATK"
                                           type="number" min="0" step="1" required />
                                </td>
                                <td>
                                    <input class="form-control form-control-sm"
                                           name="Rows[@i].DEF"
                                           value="@Model.Rows[i].DEF"
                                           type="number" min="0" step="1" required />
                                </td>
                                <td>
                                    <input class="form-control form-control-sm"
                                           name="Rows[@i].SPD"
                                           value="@Model.Rows[i].SPD"
                                           type="number" min="0" step="1" required />
                                </td>
                                <td>
                                    <input class="form-control form-control-sm"
                                           name="Rows[@i].CritRate"
                                           value="@Model.Rows[i].CritRate"
                                           type="number" min="0" max="100" step="0.1" />
                                </td>
                                <td>
                                    <input class="form-control form-control-sm"
                                           name="Rows[@i].CritDamage"
                                           value="@Model.Rows[i].CritDamage"
                                           type="number" min="0" max="1000" step="0.1" />
                                </td>
                                <td class="text-end">
                                    <button type="button" class="btn btn-sm btn-outline-danger btn-remove">삭제</button>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
        <div class="card-footer d-flex justify-content-between">
            <div class="text-muted small">레벨은 중복되면 안 됩니다.</div>
            <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">Save</button>
                <a asp-action="Index" class="btn btn-secondary">Cancel</a>
            </div>
        </div>
    </div>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
                (function () {
                    const body = document.getElementById('progBody');
                    const btnAdd = document.getElementById('btnAddRow');
                    const btnSort = document.getElementById('btnSort');
                    const btnClear = document.getElementById('btnClear');

                    function nextIndex() {
                        const rows = body.querySelectorAll('tr');
                        return rows.length;
                    }

                    function currentMaxLevel() {
                        let max = 0;
                        body.querySelectorAll('input[name$=".Level"]').forEach(inp => {
                            const v = parseInt(inp.value || '0', 10);
                            if (!Number.isNaN(v)) max = Math.max(max, v);
                        });
                        return max;
                    }

                    function addRow() {
                        const i = nextIndex();
                        const lv = Math.max(1, currentMaxLevel() + 1);

                        const tr = document.createElement('tr');
                        tr.setAttribute('data-index', i);
                        tr.innerHTML = `
        <td><input class="form-control form-control-sm" name="Rows[${i}].Level" type="number" min="1" step="1" value="${lv}" required></td>
        <td><input class="form-control form-control-sm" name="Rows[${i}].HP" type="number" min="0" step="1" value="0" required></td>
        <td><input class="form-control form-control-sm" name="Rows[${i}].ATK" type="number" min="0" step="1" value="0" required></td>
        <td><input class="form-control form-control-sm" name="Rows[${i}].DEF" type="number" min="0" step="1" value="0" required></td>
        <td><input class="form-control form-control-sm" name="Rows[${i}].SPD" type="number" min="0" step="1" value="0" required></td>
        <td><input class="form-control form-control-sm" name="Rows[${i}].CritRate" type="number" min="0" max="100" step="0.1" value="0"></td>
        <td><input class="form-control form-control-sm" name="Rows[${i}].CritDamage" type="number" min="0" max="1000" step="0.1" value="0"></td>
        <td class="text-end"><button type="button" class="btn btn-sm btn-outline-danger btn-remove">삭제</button></td>`;
                        body.appendChild(tr);
                    }

                    function renumber() {
                        // 입력 name 인덱스 재정렬 (정렬/삭제 후)
                        const rows = body.querySelectorAll('tr');
                        rows.forEach((tr, i) => {
                            tr.setAttribute('data-index', i);
                            tr.querySelectorAll('input').forEach(inp => {
                                inp.name = inp.name.replace(/Rows\[\d+\]\./, `Rows[${i}].`);
                            });
                        });
                    }

                    function sortByLevel() {
                        const rows = Array.from(body.querySelectorAll('tr'));
                        rows.sort((a, b) => {
                            const av = parseInt(a.querySelector('input[name$=".Level"]').value || '0', 10);
                            const bv = parseInt(b.querySelector('input[name$=".Level"]').value || '0', 10);
                            return av - bv;
                        });
                        rows.forEach(r => body.appendChild(r));
                        renumber();
                    }

                    function clearAll() {
                        if (!confirm('모든 행을 지울까요?')) return;
                        body.innerHTML = '';
                    }

                    body.addEventListener('click', (e) => {
                        if (e.target.classList.contains('btn-remove')) {
                            e.target.closest('tr')?.remove();
                            renumber();
                        }
                    });

                    btnAdd.addEventListener('click', addRow);
                    btnSort.addEventListener('click', sortByLevel);
                    btnClear.addEventListener('click', clearAll);
                })();
    </script>
}
