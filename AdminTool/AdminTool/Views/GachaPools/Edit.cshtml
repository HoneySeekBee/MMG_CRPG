@model AdminTool.Models.GachaPoolFormVm
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
@{
    ViewData["Title"] = "Edit Gacha Pool";
}

<div class="container py-3">
    <h2 class="mb-3">Edit Gacha Pool</h2>

    <div class="mb-3 d-flex gap-2">
        <a asp-action="Index" class="btn btn-outline-secondary">← 목록으로</a>
        @if (Model.PoolId > 0)
        {
            <!-- Detail/Details 액션 이름에 맞춰 한쪽만 사용하세요 -->
            <a asp-action="Details" asp-route-id="@Model.PoolId" class="btn btn-outline-primary">Details</a>
            @* <a asp-action="Detail" asp-route-id="@Model.PoolId" class="btn btn-outline-primary">Details</a> *@
        }
    </div>

    <form asp-action="Edit" method="post">
        @Html.AntiForgeryToken()
        <input type="hidden" asp-for="PoolId" />
        <div asp-validation-summary="ModelOnly" class="alert alert-danger"></div>

        <div class="row g-3">
            <div class="col-md-6">
                <label asp-for="Name" class="form-label"></label>
                <input asp-for="Name" class="form-control" />
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>

            <div class="col-md-3">
                <label asp-for="ScheduleStartLocal" class="form-label"></label>
                <input asp-for="ScheduleStartLocal" type="datetime-local" asp-format="{0:yyyy-MM-ddTHH:mm}" class="form-control" />
                <span asp-validation-for="ScheduleStartLocal" class="text-danger"></span>
            </div>

            <div class="col-md-3">
                <label asp-for="ScheduleEndLocal" class="form-label"></label>
                <input asp-for="ScheduleEndLocal" type="datetime-local" asp-format="{0:yyyy-MM-ddTHH:mm}" class="form-control" />
                <span asp-validation-for="ScheduleEndLocal" class="text-danger"></span>
            </div>

            <div class="col-md-4">
                <label asp-for="TablesVersion" class="form-label"></label>
                <input asp-for="TablesVersion" class="form-control" placeholder="예: v1, 2025-09-09" />
                <span asp-validation-for="TablesVersion" class="text-danger"></span>
            </div>

            <div class="col-md-4">
                <label asp-for="PityJson" class="form-label"></label>
                <textarea asp-for="PityJson" class="form-control" rows="3" placeholder='{"grade":"SSR","hardPity":90}'></textarea>
                <span asp-validation-for="PityJson" class="text-danger"></span>
            </div>

            <div class="col-md-4">
                <label asp-for="ConfigJson" class="form-label"></label>
                <textarea asp-for="ConfigJson" class="form-control" rows="3" placeholder='{"gradeRates":{"SSR":0.03,"SR":0.17,"R":0.8}}'></textarea>
                <span asp-validation-for="ConfigJson" class="text-danger"></span>
            </div>
        </div>

        <hr class="my-4" />
        <h5 class="mb-3">엔트리(확률표)</h5>

        <div class="table-responsive">
            <table class="table table-sm align-middle" id="entries-table">
                <thead class="table-light">
                    <tr>
                        <th style="width:45%;">캐릭터</th>
                        <th style="width:15%;">등급</th>
                        <th style="width:15%;">픽업</th>
                        <th style="width:15%;">가중치</th>
                        <th style="width:10%;"></th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Entries?.Count > 0)
                    {
                        for (var i = 0; i < Model.Entries.Count; i++)
                        {
                            <tr>
                                <td>
                                    <select class="form-select" name="Entries[@i].CharacterId">
                                        <option value="">-- 선택 --</option>
                                        @foreach (var opt in Model.CharacterOptions ?? Enumerable.Empty<SelectListItem>())
                                        {
                                            <option value="@opt.Value" selected="@(opt.Value == Model.Entries[i].CharacterId.ToString())">@opt.Text</option>
                                        }
                                    </select>
                                </td>
                                <td>
                                    <input class="form-control" name="Entries[@i].Grade" type="number" value="@Model.Entries[i].Grade" />
                                </td>
                                <td class="text-center">
                                    <input class="form-check-input" name="Entries[@i].RateUp" type="checkbox" value="true" @(Model.Entries[i].RateUp ? "checked" : "") />
                                    <input type="hidden" name="Entries[@i].RateUp" value="false" />
                                </td>
                                <td>
                                    <input class="form-control" name="Entries[@i].Weight" type="number" min="1" value="@Model.Entries[i].Weight" />
                                </td>
                                <td class="text-end">
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">삭제</button>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>

        <div class="d-flex gap-2 mb-3">
            <button type="button" class="btn btn-outline-primary" onclick="addRow()">+ 행 추가</button>
            <button type="button" class="btn btn-outline-secondary" onclick="addPickupTemplate()">픽업 예시 추가(등급=5)</button>
        </div>

        <div class="mt-4 d-flex gap-2">
            <button type="submit" class="btn btn-primary">저장</button>
            <a asp-action="Index" class="btn btn-outline-secondary">취소</a>
        </div>
    </form>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        function currentIndex(){
            const rows = document.querySelectorAll('#entries-table tbody tr');
            return rows.length;
        }

        function addRow(characterId = "", grade = 5, rateUp = false, weight = 1) {
            const idx = currentIndex();
            const tbody = document.querySelector('#entries-table tbody');

            // 캐릭터 옵션 HTML 스냅샷(서버 렌더링된 옵션 재사용)
            const optionsHtml = `@Html.Raw(string.Join("", (Model.CharacterOptions ?? Enumerable.Empty<SelectListItem>())
        .Select(o => $"<option value=\"{o.Value}\">{System.Net.WebUtility.HtmlEncode(o.Text)}</option>")))`;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>
                    <select class="form-select" name="Entries[${idx}].CharacterId">
                        <option value="">-- 선택 --</option>
                        ${optionsHtml}
                    </select>
                </td>
                <td>
                    <input class="form-control" name="Entries[${idx}].Grade" type="number" value="${grade}" />
                </td>
                <td class="text-center">
                    <input class="form-check-input" name="Entries[${idx}].RateUp" type="checkbox" value="true" ${rateUp ? "checked" : ""} />
                    <input type="hidden" name="Entries[${idx}].RateUp" value="false" />
                </td>
                <td>
                    <input class="form-control" name="Entries[${idx}].Weight" type="number" min="1" value="${weight}" />
                </td>
                <td class="text-end">
                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeRow(this)">삭제</button>
                </td>
            `;
            tbody.appendChild(row);

            // 선택값 반영
            if (characterId) {
                const sel = row.querySelector('select[name="Entries[' + idx +'].CharacterId"]');
                if (sel) sel.value = String(characterId);
            }
        }

        function addPickupTemplate(){
            // 간단 예시: 픽업 1개, 비픽업 2개
            addRow("", 5, true, 6);
            addRow("", 5, false, 2);
            addRow("", 5, false, 2);
        }

        function removeRow(btn){
            const tr = btn.closest('tr');
            if (!tr) return;
            tr.remove();
            reindexRows();
        }

        function reindexRows(){
            const rows = document.querySelectorAll('#entries-table tbody tr');
            rows.forEach((tr, idx) => {
                tr.querySelectorAll('select, input').forEach(el => {
                    const name = el.getAttribute('name');
                    if (!name) return;
                    el.setAttribute('name', name.replace(/Entries\[\d+\]/, `Entries[${idx}]`));
                });
            });
        }
    </script>
}
