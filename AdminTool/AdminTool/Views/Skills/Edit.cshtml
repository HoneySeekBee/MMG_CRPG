@model AdminTool.Models.SkillEditVm
@using Domain.Enum
@{
    ViewData["Title"] = "Edit Skill";
}

<h2 class="mb-3">Edit: @Model.Name (@Model.SkillId)</h2>

@if (TempData["Message"] is string msg)
{
     <div class="alert alert-success">@msg</div>
}
@if (TempData["Error"] is string err)
{
     <div class="alert alert-danger">@err</div>
}

<ul class="nav nav-tabs" id="skillTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-basic" type="button" role="tab">Basics</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-combat" type="button" role="tab">Combat</button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#tab-meta" type="button" role="tab">Meta</button>
    </li>
</ul>

<div class="tab-content border border-top-0 p-3">
    <!-- BASICS -->
    <div class="tab-pane fade show active" id="tab-basic" role="tabpanel">
        <form asp-action="Edit" asp-route-id="@Model.SkillId" method="post" class="row g-3">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="SkillId" />

            <div class="col-12">
                <label asp-for="Name" class="form-label">Name</label>
                <input asp-for="Name" class="form-control" />
                <span asp-validation-for="Name" class="text-danger"></span>
            </div>

            <!-- 아이콘 선택 -->
            <div class="col-12">
                <input asp-for="IconId" id="IconId" type="hidden" />
                <div class="d-flex align-items-center gap-2 mb-2">
                    <img id="iconPreviewImg" src="@Model.IconUrl"
                         style="width:32px;height:32px;border:1px solid #eee;border-radius:6px;object-fit:contain" />
                    <button type="button" class="btn btn-outline-primary btn-sm" data-bs-toggle="modal" data-bs-target="#iconPickerModal">
                        아이콘 선택
                    </button>
                </div>
                @await Html.PartialAsync("~/Views/Elements/PickIconModal.cshtml",
                         new PickIconModalVm
                {
                    ModalId = "iconPickerModal",
                    Icons = Model.Icons,
                    TargetHiddenId = "IconId",
                    TargetPreviewImgId = "iconPreviewImg"
                })
            </div>

            <div class="col-12 d-flex gap-2">
                <button type="submit" class="btn btn-primary">Save Basics</button>
                <a asp-action="Index" class="btn btn-outline-secondary">Back</a>
            </div>
        </form>
    </div>

    <!-- COMBAT -->
    <div class="tab-pane fade" id="tab-combat" role="tabpanel">
        <form asp-action="EditCombat" asp-route-id="@Model.SkillId" method="post" class="row g-3">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="SkillId" />

            <div class="col-md-3">
                <label asp-for="IsActive" class="form-label">Active?</label>
                <select asp-for="IsActive" class="form-select">
                    <option value="true" selected="@(Model.IsActive)">Active</option>
                    <option value="false" selected="@(!Model.IsActive)">Passive</option>
                </select>
            </div>

            <div class="col-md-3">
                <label asp-for="Type" class="form-label">Type</label>
                <select asp-for="Type" class="form-select">
                    @foreach (var opt in Model.TypeOptions)
                    {
                        <option value="@opt.Value" selected="@opt.Selected">@opt.Text</option>
                    }
                </select>
            </div>

            <div class="col-md-3">
                <label asp-for="ElementId" class="form-label">Element</label>
                <select asp-for="ElementId" class="form-select">
                    @foreach (var opt in Model.ElementOptions)
                    {
                        <option value="@opt.Value" selected="@opt.Selected">@opt.Text</option>
                    }
                </select>
            </div>

            <div class="col-md-3">
                <label asp-for="TargetingType" class="form-label">Targeting</label>
                <select asp-for="TargetingType" class="form-select" id="selTargeting">
                    @foreach (var opt in Model.TargetingTypeOptions)
                    {
                        <option value="@opt.Value" selected="@opt.Selected">@opt.Text</option>
                    }
                </select>
            </div>

            <div class="col-md-3">
                <label asp-for="TargetSide" class="form-label">Target Side</label>
                <select asp-for="TargetSide" class="form-select">
                    @foreach (var opt in Model.TargetSideOptions)
                    {
                        <option value="@opt.Value" selected="@opt.Selected">@opt.Text</option>
                    }
                </select>
            </div>

            <div class="col-md-3">
                <label asp-for="AoeShape" class="form-label">AOE Shape</label>
                <select asp-for="AoeShape" class="form-select" id="selAoe">
                    @foreach (var opt in Model.AoeShapeOptions)
                    {
                        <option value="@opt.Value" selected="@opt.Selected">@opt.Text</option>
                    }
                </select>
            </div>

            <div class="col-12">
                <button type="submit" class="btn btn-primary">Save Combat</button>
            </div>
        </form>
    </div>

    <!-- META -->
    <div class="tab-pane fade" id="tab-meta" role="tabpanel">
        <form asp-action="EditMeta" asp-route-id="@Model.SkillId" method="post" class="row g-3">
            @Html.AntiForgeryToken()
            <input type="hidden" asp-for="SkillId" />

            <!-- Tags -->
            <div class="col-12">
                <label class="form-label">Tags</label>
                <div class="d-flex gap-2">
                    <input type="text" id="tagInput" class="form-control" placeholder="ex) burn, stun (공백 없이)" style="max-width:320px;">
                    <button type="button" id="addTagBtn" class="btn btn-outline-primary">추가</button>
                </div>
                <div id="tagChips" class="mt-2 d-flex flex-wrap gap-2"></div>
                <!-- name="Tag" hidden inputs를 JS가 채움 -->
            </div>

            <!-- Etc only -->
            <div class="col-12">
                <label asp-for="Etc" class="form-label">Base Info - Etc</label>
                <input asp-for="Etc" class="form-control" placeholder="설명/메모 등 자유 입력" />
                <span asp-validation-for="Etc" class="text-danger"></span>
                @* (선택) Raw BaseInfo 조회용 read-only
                <small class="text-muted">Raw: @Model.BaseInfo</small> *@
            </div>

            <div class="col-12">
                <button type="submit" class="btn btn-primary">Save Meta</button>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />
    <script>
        // Passive면 Targeting/AOE 비활성화
        (function(){
          const isActiveSel = document.querySelector('[name="IsActive"]');
          const targetingSel = document.getElementById('selTargeting');
          const aoeSel = document.getElementById('selAoe');
          function refresh(){
            const active = (isActiveSel.value === 'true');
            targetingSel.disabled = !active;
            aoeSel.disabled = !active;
            if(!active){ targetingSel.value = '0'; aoeSel.value = '0'; } // enum None=0 가정
          }
          isActiveSel.addEventListener('change', refresh);
          refresh();
        })();

        // Tags 칩 UI (+ 초기값 렌더링)
        (function(){
          const chips = document.getElementById('tagChips');
          const input = document.getElementById('tagInput');
          const addBtn = document.getElementById('addTagBtn');
          const tags = new Set();
          const valid = t => /^[a-z0-9_-]+$/i.test(t);

          // 초기값: 서버 모델에 있는 Tag 배열 반영
          const initial = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.Tag ?? Array.Empty<string>()));
          (initial || []).forEach(t => tags.add((t || '').toLowerCase()));

          function syncHidden() {
            chips.querySelectorAll('input[type=hidden][name=Tag]').forEach(x => x.remove());
            for (const t of tags) {
              const h = document.createElement('input');
              h.type='hidden'; h.name='Tag'; h.value=t;
              chips.appendChild(h);
            }
          }
          function render(){
            chips.querySelectorAll('.tag-chip').forEach(x=>x.remove());
            for (const t of tags) {
              const span=document.createElement('span');
              span.className='badge bg-secondary tag-chip';
              span.textContent=t+' ';
              const x=document.createElement('button');
              x.type='button'; x.className='btn-close btn-close-white btn-sm ms-1';
              x.addEventListener('click', ()=>{ tags.delete(t); render(); syncHidden(); });
              span.appendChild(x); chips.appendChild(span);
            }
          }
          function add(){
            const raw=(input.value||'').trim(); if(!raw) return;
            const t=raw.toLowerCase();
            if(!valid(t)){ alert('영문/숫자/-,_ 만 허용 (공백 불가)'); return; }
            tags.add(t); input.value=''; render(); syncHidden();
          }
          addBtn.addEventListener('click', add);
          input.addEventListener('keydown', e => { if(e.key==='Enter'){ e.preventDefault(); add(); }});

          // 초기 렌더
          render(); syncHidden();
        })();
    </script>
}
